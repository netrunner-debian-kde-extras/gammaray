From: Jakub Adam <jakub.adam@ktknet.cz>
Date: Sun, 8 Jul 2012 17:36:36 +0200
Subject: gammaray-probe-versioned-soname

---
 CMakeLists.txt           |    1 +
 config-gammaray.h.cmake  |    1 +
 core/CMakeLists.txt      |    2 +-
 launcher/probefinder.cpp |    2 +-
 4 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 0ce0cee..b3b6684 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -28,6 +28,7 @@ set(GAMMARAY_VERSION_MINOR "3")
 set(GAMMARAY_VERSION_PATCH "1")
 set(GAMMARAY_VERSION "${GAMMARAY_VERSION_MAJOR}.${GAMMARAY_VERSION_MINOR}.${GAMMARAY_VERSION_PATCH}")
 set(GAMMARAY_VERSION_STRING "${GAMMARAY_VERSION}")
+set(GAMMARAY_PROBE_SOVERSION "${GAMMARAY_VERSION_STRING}")
 
 set(CMAKE_INSTALL_RPATH_USE_LINK_PATH TRUE)
 
diff --git a/config-gammaray.h.cmake b/config-gammaray.h.cmake
index 11c8cc3..b79c05d 100644
--- a/config-gammaray.h.cmake
+++ b/config-gammaray.h.cmake
@@ -1,5 +1,6 @@
 #define GAMMARAY_LIB_INSTALL_DIR "${CMAKE_INSTALL_PREFIX}/${LIB_INSTALL_DIR}"
 #define GAMMARAY_PLUGIN_INSTALL_DIR "${CMAKE_INSTALL_PREFIX}/${PLUGIN_INSTALL_DIR}"
+#define GAMMARAY_PROBE_SOVERSION "${GAMMARAY_PROBE_SOVERSION}"
 // for finding the probe during automatic tests
 #define GAMMARAY_BUILD_DIR "${CMAKE_BINARY_DIR}"
 
diff --git a/core/CMakeLists.txt b/core/CMakeLists.txt
index 3831d1a..5f4ec80 100644
--- a/core/CMakeLists.txt
+++ b/core/CMakeLists.txt
@@ -194,6 +194,6 @@ endif()
 if(NOT WIN32)
   target_link_libraries(gammaray_probe dl)
 endif()
-set_target_properties(gammaray_probe PROPERTIES PREFIX "")
+set_target_properties(gammaray_probe PROPERTIES SOVERSION ${GAMMARAY_PROBE_SOVERSION})
 
 install(TARGETS gammaray_probe ${INSTALL_TARGETS_DEFAULT_ARGS})
diff --git a/launcher/probefinder.cpp b/launcher/probefinder.cpp
index 7590e47..a6a8b44 100644
--- a/launcher/probefinder.cpp
+++ b/launcher/probefinder.cpp
@@ -50,7 +50,7 @@ QString findProbe(const QString &baseName)
 #ifdef Q_OS_MAC
   QFile plfile(QLatin1Literal("preloads:") % baseName % QLatin1Literal(".dylib"));
 #else
-  QFile plfile(QLatin1Literal("preloads:") % baseName % QLatin1Literal(".so"));
+  QFile plfile(QLatin1Literal("preloads:") % QLatin1Literal("lib") % baseName % QLatin1Literal(".so." GAMMARAY_PROBE_SOVERSION));
 #endif
   if (plfile.exists()) {
     return plfile.fileName();
